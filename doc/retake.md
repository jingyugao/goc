# retake
目的:避免一个协程运行太久，饿死其他协程。

## 判断协程是否运行太久
1. 时间片分配。
2. 测量协程运行时间
3. 如果太久，进行抢占。


### 时间片分配
1. 协程从runq中取出投入运行时，分配一个时间片。
2. 如果协程主动让出时间片,计算剩余的时间片，下次运行时加上一部分。


### 时间片测量
1. 分配时间片时，记录当前时间。
2. 定期检查时间片是否超限。


### 抢占
gcc -finstrument-functions
此标志会在编译时，在函数入口处插入代码。调用hook函数。

## 问题
1. 主动让出时间片的协程应该比被动让出的要友好。应该多被调度。
2. 避免某个协程的一些操作可以使自己时间片过高。

